<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scan Product Barcode</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    #reader {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      border: 3px solid #667eea;
    }

    .status {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.scanning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .last-scanned {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }

    .last-scanned-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .last-scanned-value {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      font-family: monospace;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-secondary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }

    .info strong {
      color: #333;
    }

    .connection-info {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 12px;
      color: #666;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 15px;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    /* Permission Dialog Styles */
    .permission-dialog {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .permission-dialog.show {
      display: flex;
    }

    .permission-dialog-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .permission-dialog-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .permission-dialog-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }

    .permission-dialog-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 25px;
      line-height: 1.5;
    }

    .permission-dialog-buttons {
      display: flex;
      gap: 10px;
    }

    .permission-dialog-buttons button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-allow {
      background: #667eea;
      color: white;
    }

    .btn-allow:hover {
      background: #5568d3;
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
    }

    .btn-cancel:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“± Scan Product Barcode</h1>
    <p class="subtitle">Point camera at product barcode</p>

    <div id="status" class="status disconnected">
      <span id="status-icon">ðŸ”´</span>
      <span id="status-text">Connecting...</span>
    </div>

    <div id="reader"></div>

    <div class="last-scanned" id="lastScanned" style="display: none;">
      <div class="last-scanned-label">Last Scanned:</div>
      <div class="last-scanned-value" id="lastScannedValue">-</div>
    </div>

    <div class="controls">
      <button class="btn-primary" id="startBtn" onclick="startScanning()">Start Scanner</button>
      <button class="btn-secondary" id="stopBtn" onclick="stopScanning()" disabled>Stop Scanner</button>
    </div>

    <div class="info">
      <strong>Instructions:</strong><br>
      1. Click "Start Scanner" to begin<br>
      2. Point camera at product barcode<br>
      3. Barcode will be sent to laptop automatically<br>
      4. Make sure laptop is on the same Wi-Fi network
    </div>

    <div class="connection-info">
      <strong>Server:</strong> <span id="serverUrl">http://localhost:3001</span><br>
      <strong>Status:</strong> <span id="connectionStatus">Disconnected</span>
    </div>
  </div>

  <!-- Camera Permission Dialog -->
  <div id="permissionDialog" class="permission-dialog">
    <div class="permission-dialog-content">
      <div class="permission-dialog-icon">ðŸ“·</div>
      <div class="permission-dialog-title">Camera Permission Required</div>
      <div class="permission-dialog-message" id="permissionDialogMessage">
        This app needs access to your camera to scan barcodes.<br><br>
        <strong>Click "Allow Camera" to grant permission.</strong><br><br>
        If permission was previously denied, you may need to:<br>
        1. Click the camera icon in your browser's address bar<br>
        2. Allow camera access<br>
        3. Refresh this page<br><br>
        <strong>Note:</strong> Please use a modern browser like Chrome, Firefox, or Safari for best results.
      </div>
      <div class="permission-dialog-buttons">
        <button class="btn-allow" onclick="requestCameraPermission()">Allow Camera</button>
        <button class="btn-cancel" onclick="closePermissionDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let html5QrCode;
    let socket;
    let isScanning = false;
    let lastScannedBarcode = "";

    // Get server URL - automatically detect from current page URL for local development
    // Falls back to production URL if needed
    function getServerUrl() {
      return `https://nicknameinfo.net`;
    }

    const serverUrl = getServerUrl();
    document.getElementById('serverUrl').textContent = serverUrl;

    // Wait for Html5Qrcode library to load
    window.addEventListener('load', () => {
      // Check if library is already loaded
      if (window.Html5Qrcode) {
        console.log('Html5Qrcode library already loaded');
        return;
      }

      // Wait for library to load (it's loaded via script tag)
      const checkLibrary = () => {
        if (window.Html5Qrcode) {
          console.log('Html5Qrcode library loaded');
        } else {
          setTimeout(checkLibrary, 100);
        }
      };
      checkLibrary();
    });

    // Initialize Socket.IO
    function initSocket() {
      socket = io(serverUrl, {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
      });

      socket.on('connect', () => {
        console.log('Connected to server');
        updateStatus('connected', 'ðŸŸ¢ Connected to server');
        document.getElementById('connectionStatus').textContent = 'Connected';
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
        updateStatus('disconnected', 'ðŸ”´ Disconnected');
        document.getElementById('connectionStatus').textContent = 'Disconnected';
      });

      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        updateStatus('disconnected', 'ðŸ”´ Connection failed');
        document.getElementById('connectionStatus').textContent = 'Connection failed';
      });
    }

    function updateStatus(type, text) {
      const statusEl = document.getElementById('status');
      const statusText = document.getElementById('status-text');
      
      statusEl.className = `status ${type}`;
      statusText.textContent = text;
    }

    function onScanSuccess(decodedText, decodedResult) {
      console.log("Scanned:", decodedText);

      // Avoid duplicate scans
      if (decodedText === lastScannedBarcode) {
        return;
      }

      lastScannedBarcode = decodedText;

      // Show last scanned
      document.getElementById('lastScanned').style.display = 'block';
      document.getElementById('lastScannedValue').textContent = decodedText;

      // Send to server
      if (socket && socket.connected) {
        socket.emit("scan-product", decodedText);
        updateStatus('scanning', 'âœ… Barcode sent: ' + decodedText);
        
        // Reset status after 2 seconds
        setTimeout(() => {
          if (isScanning) {
            updateStatus('scanning', 'ðŸŸ¡ Scanning...');
          }
        }, 2000);
      } else {
        updateStatus('disconnected', 'âŒ Not connected - barcode not sent');
      }
    }

    function onScanFailure(error) {
      // Ignore scan failures (camera might be adjusting)
    }

    // Check camera permission
    async function checkCameraPermission() {
      try {
        // Check if browser supports getSettings
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          // Try to get camera stream to check permission
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          // If successful, stop the stream immediately (we just wanted to check)
          stream.getTracks().forEach(track => track.stop());
          return true;
        }
        return false;
      } catch (error) {
        console.log('Camera permission check:', error.name);
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          return false;
        }
        // Other errors might be device not found, etc.
        return null;
      }
    }

    // Show permission dialog
    function showPermissionDialog() {
      const dialog = document.getElementById('permissionDialog');
      const messageEl = document.getElementById('permissionDialogMessage');
      
      // Customize message based on browser support
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        if (messageEl) {
          messageEl.innerHTML = `
            Your browser may not fully support camera access.<br><br>
            <strong>Please try:</strong><br>
            1. Use a modern browser like Chrome, Firefox, or Safari<br>
            2. Make sure you're using HTTPS or localhost<br>
            3. Check browser settings for camera permissions<br>
            4. Try refreshing the page<br><br>
            <strong>Click "Allow Camera" to attempt camera access anyway.</strong>
          `;
        }
      } else {
        if (messageEl) {
          messageEl.innerHTML = `
            This app needs access to your camera to scan barcodes.<br><br>
            <strong>Click "Allow Camera" to grant permission.</strong><br><br>
            If permission was previously denied, you may need to:<br>
            1. Click the camera icon in your browser's address bar<br>
            2. Allow camera access<br>
            3. Refresh this page
          `;
        }
      }
      
      dialog.classList.add('show');
    }

    // Close permission dialog
    function closePermissionDialog() {
      const dialog = document.getElementById('permissionDialog');
      dialog.classList.remove('show');
    }

    // Request camera permission
    async function requestCameraPermission() {
      closePermissionDialog();
      updateStatus('scanning', 'ðŸŸ¡ Requesting camera permission...');
      
      // Check if browser supports camera API
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        const errorMessage = "Your browser does not support camera access.\n\nPlease:\n1. Use a modern browser like Chrome, Firefox, or Safari\n2. Make sure you're using HTTPS or localhost\n3. Check if your browser supports camera access";
        updateStatus('disconnected', 'âŒ Browser not supported');
        alert(errorMessage);
        return;
      }
      
      try {
        // Request camera permission
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "environment" 
          } 
        });
        
        // Permission granted, stop the test stream
        stream.getTracks().forEach(track => track.stop());
        
        // Now start the actual scanner
        updateStatus('scanning', 'ðŸŸ¡ Starting scanner...');
        await startScanner();
      } catch (error) {
        console.error("Camera permission error:", error);
        let errorMessage = "Camera access denied.";
        let statusMessage = "âŒ Camera error";
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          errorMessage = "Camera permission was denied.\n\nPlease:\n1. Click the camera icon in your browser's address bar\n2. Allow camera access\n3. Refresh this page and try again";
          statusMessage = "âŒ Permission denied - Check browser settings";
          // Show dialog again with instructions
          setTimeout(() => {
            showPermissionDialog();
          }, 1000);
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
          errorMessage = "No camera found. Please connect a camera device.";
          statusMessage = "âŒ No camera found";
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
          errorMessage = "Camera is already in use by another application. Please close other apps using the camera.";
          statusMessage = "âŒ Camera in use";
        } else if (error.name === 'OverconstrainedError') {
          errorMessage = "Camera does not support the required settings. Trying alternative settings...";
          statusMessage = "ðŸŸ¡ Trying alternative camera...";
          // Try without facingMode constraint
          try {
            const stream2 = await navigator.mediaDevices.getUserMedia({ video: true });
            stream2.getTracks().forEach(track => track.stop());
            await startScanner();
            return;
          } catch (e) {
            errorMessage = `Camera error: ${e.message || e.name}`;
          }
        } else {
          errorMessage = `Camera error: ${error.message || error.name}`;
        }
        
        updateStatus('disconnected', statusMessage);
        alert(errorMessage);
      }
    }

    // Start scanner (internal function)
    async function startScanner() {
      if (isScanning) return;

      // Check if library is loaded
      if (!window.Html5Qrcode) {
        updateStatus('disconnected', 'âŒ Scanner library not loaded');
        alert('Scanner library is loading. Please wait a moment and try again.');
        return;
      }

      // Wait a bit to ensure DOM is ready
      await new Promise(resolve => setTimeout(resolve, 200));

      const readerElement = document.getElementById('reader');
      if (!readerElement) {
        updateStatus('disconnected', 'âŒ Scanner container not found');
        alert('Scanner container not found');
        return;
      }

      // Clear any existing scanner instance
      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          await html5QrCode.clear();
        } catch (e) {
          console.warn('Error clearing previous scanner:', e);
        }
        html5QrCode = null;
      }

      // Clear the container content (scanner will render into it)
      readerElement.innerHTML = '';

      const Html5Qrcode = window.Html5Qrcode;
      html5QrCode = new Html5Qrcode("reader");

      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        onScanSuccess,
        onScanFailure
      ).then(() => {
        isScanning = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        updateStatus('scanning', 'ðŸŸ¡ Scanning...');
      }).catch(async (err) => {
        console.error("Error starting scanner:", err);
        console.error("Error details:", {
          name: err.name,
          message: err.message,
          stack: err.stack
        });
        
        let errorMessage = "Failed to start camera.";
        
        if (err.name === 'NotAllowedError' || err.message?.includes('permission')) {
          errorMessage = "Camera permission denied. Please allow camera access.";
          showPermissionDialog();
        } else if (err.message?.includes('not found') || err.message?.includes('No camera')) {
          errorMessage = "No camera found. Please connect a camera device.";
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
          errorMessage = "Camera is already in use by another application.";
        } else if (err.name === 'OverconstrainedError') {
          // Try without facingMode constraint
          try {
            // Clear previous instance
            if (html5QrCode) {
              try {
                await html5QrCode.stop();
                await html5QrCode.clear();
              } catch (e) {
                // Ignore cleanup errors
              }
              html5QrCode = null;
            }

            readerElement.innerHTML = '';
            html5QrCode = new Html5Qrcode("reader");
            
            await html5QrCode.start(
              { facingMode: "user" },
              {
                fps: 10,
                qrbox: { width: 250, height: 250 }
              },
              onScanSuccess,
              onScanFailure
            );
            
            isScanning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            updateStatus('scanning', 'ðŸŸ¡ Scanning...');
            return; // Success with fallback
          } catch (retryErr) {
            console.error('Retry error:', retryErr);
            errorMessage = `Camera error: ${retryErr.message || retryErr.name || 'Unknown error'}`;
          }
        } else {
          errorMessage = `Camera error: ${err.message || err.name || 'Unknown error'}`;
        }
        
        updateStatus('disconnected', 'âŒ ' + errorMessage);
        alert(errorMessage);
        
        // Clean up failed instance
        html5QrCode = null;
      });
    }

    // Public function called by button
    async function startScanning() {
      if (isScanning) return;

      // Check if library is loaded
      if (!window.Html5Qrcode) {
        updateStatus('disconnected', 'âŒ Scanner library not loaded');
        alert('Scanner library is loading. Please wait a moment and try again.');
        return;
      }

      // Check if browser supports camera API
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        // Instead of alert, show permission dialog with helpful message
        updateStatus('disconnected', 'ðŸ”´ Camera access required');
        showPermissionDialog();
        return;
      }

      // Check camera permission first
      updateStatus('scanning', 'ðŸŸ¡ Checking camera permission...');
      
      try {
        const hasPermission = await checkCameraPermission();
        
        if (hasPermission === false) {
          // Permission denied, show dialog
          updateStatus('disconnected', 'ðŸ”´ Camera permission required');
          showPermissionDialog();
          return;
        } else if (hasPermission === null) {
          // Unknown state (might be device not found), try to start anyway
          updateStatus('scanning', 'ðŸŸ¡ Starting camera...');
          await startScanner();
          return;
        }
        
        // Permission granted, start scanner
        updateStatus('scanning', 'ðŸŸ¡ Starting camera...');
        await startScanner();
      } catch (error) {
        console.error("Permission check error:", error);
        // If check fails, show dialog to request permission
        updateStatus('disconnected', 'ðŸ”´ Camera permission required');
        showPermissionDialog();
      }
    }

    async function stopScanning() {
      if (!isScanning || !html5QrCode) return;

      try {
        await html5QrCode.stop();
        await html5QrCode.clear();
        html5QrCode = null;
        isScanning = false;
        lastScannedBarcode = ""; // Clear to allow re-scanning
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        updateStatus('connected', 'ðŸŸ¢ Scanner stopped');
      } catch (err) {
        console.error("Error stopping scanner:", err);
        // Force cleanup even if stop fails
        isScanning = false;
        html5QrCode = null;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        updateStatus('connected', 'ðŸŸ¢ Scanner stopped');
      }
    }

    // Initialize on page load
    window.addEventListener('load', () => {
      initSocket();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', async () => {
      if (isScanning && html5QrCode) {
        try {
          await html5QrCode.stop();
          await html5QrCode.clear();
        } catch (e) {
          // Ignore cleanup errors
        }
      }
      if (socket) {
        socket.disconnect();
      }
    });
  </script>
</body>
</html>

